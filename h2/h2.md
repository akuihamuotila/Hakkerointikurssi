# h2 Break & Unbreak

---

## x)

### OWASP: OWASP Top 10: A01 Broken Access Control

 - Broken Access Control on OWASP top 10:ssa yleisin ja vakavin haavoittuvuus.
 - Käyttäjä pääsee käsiksi resursseihin ja/tai toimintoihin ilman vaadittuja oikeuksia.
 - Syynä voi olla esimerkiksi se, että vaikka joku nappi on piilotettu frontendissä, mutta backend ei estä sen toimintoa.
 - Voidaan ehkäistä esimerkiksi siten, että oikeudet muutoksiin annetaan vain jos ne on erikseen tarkistettu ja oletuksena mitään muutoksia ei voi tehdä.

### Karvinen 2023: Find Hidden Web Directories - Fuzz URLs with ffuf

 - Web-hakemistoja ja tiedostoja voidaan löytää automatisoidulla fuzzauksella, eli niin, että hyökkääjä kokeilee automaattisesti monia eri URL-polkuja. Käytetään listaa yleisistä nimistä.
 - Sivulla voi olla olemassa enemmän linkkejä kun on näkyvissä (esim. admin-, test-, backup- tai unreleasedsivut.)
 - Kun testataan eri polkuja, niin tarkastellaan samalla palvelimen vastauksia ja niissä mahdollisia muutoksia.
 - Se että URL on 'piilotettu' ei ole puolustus/suojaus.

### PortSwigger: Access control vulnerabilities and privilege escalation

 - Kirjautuminen tunnistaa käyttäjän ja access control kertoo mitä hän saa tehdä.
 - Privilege escalation tarkoittaa oikeuksien laajenemista.
    - Vertical: Tavallinen käyttäjä saa käyttöönsä admin-toimintoja.
    - Horizontal: Tavallinen käyttähä pääsee toisen käyttäjän tietoihin.
 - Oikeuksien laajenemiset johtuvat vääristä/puuttuvista tarkistuksista backendissä.

### Karvinen 2006: Report Writing (in Finnish)

 - Raportin tulee olla niin täsmällinen, että sitä seuraamalla tulee täysin samat tulokset, kuin mitä sitä tehdessä saatiin.
 - Käytetään väliotsikoita ja huolellista kieltä.
 - Viitataan lähteisiin, ollaan rehellisiä, ei plagioida

---

## a)

 - Ajoin ohjelman ja avasin sivun Brave-selaimella
 - avasin inspect elementin ja etsin sieltä kohdan koodista joka pakotti käyttäjän kirjoittamaan vain numeroita kenttään ja laitoin siihen number tilalle varchar
 - kokeilin kirjoittaa 0' OR '1'='1 siihen, mutta passwordiksi tuli 'foo'
 - Kun sivu hakee salasanan SELECT kyselyllä tuli mieleeni UNION komento, jolla tuota 'SELECT password FROM pins' voisi ajaa ja laajentaa tulosjoukkoa, kun pelkällään "'SELECT password FROM pins--" ei toiminut
 - Ajan siis "' UNION SELECT password FROM pins--"
 - Tulosteeksi tuli seuraava:
    Your password is SUPERADMIN%%rootALL-FLAG{Tero-e45f8764675e4463db969473b6d0fcdd}
 - Tehtävä suoritettu

---

## b)

 - Tein seuraavat korjaukset koodiin tiedostossa staff-only.py:
```python
# sql = "SELECT password FROM pins WHERE pin='"+pin+"';"
sql = text("SELECT password FROM pins WHERE pin = :pin") # <<< KORJAUS
```
    - Nyt PIN:iä ei liitetä suoraan SQL-merkkijonoon
    - Eli nyt SQL-kysely määritellään kiinteästi etukäteen ja PIN ei syöte ei tule osaksi SQL koodia.
```python
# res = db.session.execute(text(sql))
res = db.session.execute(sql, {"pin": pin}) # <<< KORJAUS
```
    - Alunperin käyttäjän syöte sisällä SQL merkkijonossa
    - Korjauksessa SQL ja syöte tulevat erillisinä ja pin tulee parametrina, ei osana SQL-koodia.

 - Korjausten jälkeen ajoin ohjelman lokaalisti ja testasin tunkeutumistapaa, jota käytin edellisessä kohdassa ja se ei enää tominut.

---

## c)

 - Asensin fuffin ja harjoituskohteen https://terokarvinen.com/2023/fuzz-urls-find-hidden-directories/ -ohjeiden mukaisesti.
 - Ajoin harjoituskohteen dirfuzt-0 lokaalisti.
 - Ajoin komennon: ffuf -w common.txt -u http://127.0.0.2:8000/FUZZ
 - Tulosti suuren listan ja todella monissa näkyy size 132.
 - Ajoin komennon: ffuf -w common.txt -u http://127.0.0.2:8000/FUZZ -fs 132
   - Näin filtteröin pois suurimman osan tuloksista.
 - Tuloste:
    ``` $  ffuf -w common.txt -u http://127.0.0.2:8000/FUZZ -fs 132

            /'___\  /'___\           /'___\       
        /\ \__/ /\ \__/  __  __  /\ \__/       
        \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      
            \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      
            \ \_\   \ \_\  \ \____/  \ \_\       
            \/_/    \/_/   \/___/    \/_/       

        v2.1.0-dev
    ________________________________________________

    :: Method           : GET
    :: URL              : http://127.0.0.2:8000/FUZZ
    :: Wordlist         : FUZZ: /home/ihis/common.txt
    :: Follow redirects : false
    :: Calibration      : false
    :: Timeout          : 10
    :: Threads          : 40
    :: Matcher          : Response status: 200-299,301,302,307,401,403,405,500
    :: Filter           : Response size: 132
    ________________________________________________

    admin                   [Status: 200, Size: 160, Words: 10, Lines: 11, Duration: 0ms]
    render/https://www.google.com [Status: 301, Size: 64, Words: 3, Lines: 3, Duration: 0ms]
    :: Progress: [4751/4751] :: Job [1/1] :: 0 req/sec :: Duration: [0:00:00] :: Errors: 0 :: ```

 - Nyt testaan browserissa: http://127.0.0.2:8000/admin
   - Sivulla lukee "You found it! / See you at TeroKarvinen.com !"

 - Siirrytään dirfuzt-1, lataan ja käynnistän sen
 - Nyt se auki selaimessa http://127.0.0.2:8000/ ajan uudessa terminaalissa komennon: ffuf -w common.txt -u http://127.0.0.2:8000/FUZZ
   - Size 154 toistuu.
   - Ajan komennon ffuf -w common.txt -u http://127.0.0.2:8000/FUZZ -fs 154
     - Tuloste:
     ```
     $  ffuf -w common.txt -u http://127.0.0.2:8000/FUZZ -fs 154

        /'___\  /'___\           /'___\       
       /\ \__/ /\ \__/  __  __  /\ \__/       
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      
         \ \_\   \ \_\  \ \____/  \ \_\       
          \/_/    \/_/   \/___/    \/_/       

       v2.1.0-dev
    ________________________________________________

    :: Method           : GET
    :: URL              : http://127.0.0.2:8000/FUZZ
    :: Wordlist         : FUZZ: /home/ihis/common.txt
    :: Follow redirects : false
    :: Calibration      : false
    :: Timeout          : 10
    :: Threads          : 40
    :: Matcher          : Response status: 200-299,301,302,307,401,403,405,500
    :: Filter           : Response size: 154
    ________________________________________________

    .git/index              [Status: 200, Size: 178, Words: 6, Lines: 11, Duration: 0ms]
    .git/HEAD               [Status: 200, Size: 178, Words: 6, Lines: 11, Duration: 0ms]
    .git                    [Status: 301, Size: 41, Words: 3, Lines: 3, Duration: 0ms]
    .git/logs/              [Status: 200, Size: 178, Words: 6, Lines: 11, Duration: 0ms]
    .git/config             [Status: 200, Size: 178, Words: 6, Lines: 11, Duration: 0ms]
    render/https://www.google.com [Status: 301, Size: 64, Words: 3, Lines: 3, Duration: 1ms]
    wp-admin                [Status: 200, Size: 182, Words: 6, Lines: 11, Duration: 0ms]
    :: Progress: [4751/4751] :: Job [1/1] :: 0 req/sec :: Duration: [0:00:00] :: Errors: 0 :: ```

 - Eli löytyi seuraavat:
    .git/index
    .git/HEAD
    .git
    .git/logs/
    .git/config
    render/https://www.google.com
    wp-admin
 - Esim. http://127.0.0.2:8000/wp-admin löytyy seuraava: You found it! FLAG{tero-wpadmin-3364c855a2ac87341fc7bcbda955b580}

---

## d)

 - Asensin tarvittavat asiat ja käynnistin sovelluksen Karvinen 2024: Hack'n Fix -ohjeiden mukaan.
 - Kokeilin:
 http://127.0.0.1:8000/admin
 http://127.0.0.1:8000/dashboard
   - Molemmilla page not found.
 - Ajoin terminaalissa: ffuf -w common.txt -u http://127.0.0.1:8000/FUZZ
 - Jo scrollaamalla tulostetta löysin yläpäästä:
 "... :: Progress: [535/4751] :: Job [1/1] :: 170 req/sec :: Duration: [:: Progress: [549/4751] :: Job [1/1] :: 156 req/sec :: Duration: [admin-console           [Status: 301, Size: 0, Words: 1, Lines: 1, Duration: 137ms]
:: Progress: [549/4751] :: Job [1/1] :: 156 req/sec :: Duration: [:: Progress: [570/4751] :: Job [1/1] :: 174 req/sec :: Duration: [ ..."

 - Kokeilen selaimessa: http://127.0.0.1:8000/admin-console
 - Aukeaa: http://127.0.0.1:8000/accounts/login/?next=/admin-console/
   - Eli uusi admin console kirjautumissivu.
 - Tein käyttäjän ja kirjauduin sisään.
 - Painoin Admin Dashboard, jolloin tuli viesti 403 Forbidden.
 - Sitten vaihdoin urlin:
 http://127.0.0.1:8000/admin-dashboard/
 ---> http://127.0.0.1:8000/admin-console/
 - Tällä sivulla lukee "Admin secret page
Well done, you've found the secret page."
 - Tehtävä tehty.

---

## e)

 - Ajan logtin -kansiossa: grep -R "admin-console" -n .
 - Tulosteen avulla löydän ongelman kansiosta hats, views.py tiedostosta.
 - Korjasin koodin seuraavasti:
```python
class AdminShowAllView(UserPassesTestMixin, TemplateView):
	template_name="hats/admin-show-all.html"

	def test_func(self):
		# return self.request.user.is_authenticated
		return self.request.user.is_authenticated and self.request.user.is_staff # <<< KORJAUS
```
 - Nyt koodi varmistaa, että sivu aukeaa vain staff-käyttäjille
 - Ajoin ohjelman korjauksilla lokaalisti ja Toistin d) kohdan toimenpiteet uudelleen ja en päässyt enää salaiselle sivulle, joten ongelma korjattu.
